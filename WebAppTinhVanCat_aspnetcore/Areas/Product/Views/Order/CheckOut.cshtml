@using WebAppTinhVanCat_aspnetcore.Areas.Product.Models;
@model CheckoutModel;



@{
    var ListCartItem =  ViewData["ListCartItem"] as List<CartItem>;

    Layout = "_Layout";
    ViewData["Title"] = "Thanh Toán";

}
<h2>Thanh Toán</h2>
<hr />


@if (ListCartItem.Count > 0)
{
    decimal total = 0;
    int stt = 1;

    <table class="table">
        <tr>
            <th>STT</th>
            <th>Ảnh</th>
            <th>Sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th></th>
        </tr>
        @foreach (var cartitem in ListCartItem)
        {
            var thanhtien = cartitem.quantity * cartitem.product.Price;
            total += thanhtien;
            var srcimg = (cartitem.product.Photos != null) && (cartitem.product.Photos.Count > 0) ? "/contens/Products/" + cartitem.product.Photos.First().FileName : "/contens/ico/nophoto.png";

            <tr>
                <td>@(stt++)</td>
                <td> <img class="cart-photo" src="@srcimg" alt=""> </td>
                <td>@cartitem.product.Title</td>
                <td>
                    @cartitem.product.Price.ToPriceUnitVND()
                </td>
                <td><input asp-for="@cartitem.quantity" id="@($"quantity-{cartitem.product.ProductId}")" /> @cartitem.product.UnitProduct.Unit </td>
                <td>
                    @thanhtien.ToPriceUnitVND()
                </td>
            </tr>
        }
        <tr>
            <td colspan="4" class="text-right">Tổng tiền</td>
            <td>
                @total.ToPriceUnitVND()
            </td>
            <td></td>
        </tr>
    </table>

    <hr />
    <form asp-action="CheckoutConfirm" method="post">
        <h5> Địa chỉ giao hàng </h5>

        <div class="form-group">
            <label asp-for="DcTinh" class="control-label"></label>
            <select asp-for="DcTinh"  id="city" >
                <option value="" selected >Chọn tỉnh thành</option>
            </select>
            <span asp-validation-for="DcTinh" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="DcHuyen" class="control-label"></label>
            <select asp-for="DcHuyen" id="district" >
                <option value="" selected>Chọn quận huyện</option>
            </select>
            <span asp-validation-for="DcHuyen" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="DcXa" class="control-label"></label>
            <select asp-for="DcXa" id="ward" >
                <option value="" selected>Chọn phường xã</option>
            </select>
            <span asp-validation-for="DcXa" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="SoNha" class="control-label"></label>
            <input asp-for="SoNha" class="form-control" />
            <span asp-validation-for="SoNha" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="PhoneNumber" class="control-label"></label>
            <input asp-for="PhoneNumber" class="form-control" />
            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
        </div>
         <h5> Phương thức thanh toán</h5>

        <div class="form-group">
            <input type="submit" value="Đặt Hàng" class="btn btn-primary" />
        </div>
    </form>
    
}


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="~/js/axios/axios.min.js"></script>
    <script>
        var citis = document.getElementById("city");
        var districts = document.getElementById("district");
        var wards = document.getElementById("ward");
        var Parameter = {
            url: "@Url.Content("~/json/DiaGioiHanhChinhVN.json")",
            method: "GET",
            responseType: "application/json",
        };
        var promise = axios(Parameter);
        promise.then(function (result) {
            renderCity(result.data);
        });

        function renderCity(data) {
            for (const x of data) {
                citis.options[citis.options.length] = new Option(x.Name, x.Id);
                
                
            }

            citis.onchange = function () {
                district.length = 1;
                ward.length = 1;
                if (this.value != "") {
                    const result = data.filter(n => n.Id === this.value);

                    for (const k of result[0].Districts) {
                        district.options[district.options.length] = new Option(k.Name, k.Id);
                    }
                }
            };
            district.onchange = function () {
                ward.length = 1;
                const dataCity = data.filter((n) => n.Id === citis.value);
                if (this.value != "") {
                    const dataWards = dataCity[0].Districts.filter(n => n.Id === this.value)[0].Wards;

                    for (const w of dataWards) {
                        wards.options[wards.options.length] = new Option(w.Name, w.Id);
                    }
                }
            };
        }
    </script>


}
